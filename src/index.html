<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis y Demo | MNIST AI</title>
    
    <!-- SDKs de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <style>
        :root {
            --background-color: #f7f7f7;
            --card-background: #ffffff;
            --text-color: #333;
            --header-color: #111;
            --border-color: #e8e8e8;
            --accent-color-success: #28a745;
            --accent-color-danger: #dc3545;
            --accent-color-primary: #007aff;
            --button-color: #007aff;
            --button-hover-color: #0056b3;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        body { font-family: var(--font-family); margin: 0; background-color: var(--background-color); color: var(--text-color); }
        .container { max-width: 1100px; margin: 2rem auto; padding: 0 1.5rem; }
        .card { background: var(--card-background); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem 2rem; margin-bottom: 2rem; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
        h1, h2, h3 { color: var(--header-color); font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 0.6rem; margin: 0 0 1rem 0; }
        h1 { font-size: 2.2rem; }
        h2 { font-size: 1.8rem; margin-top: 1rem; }
        h3 { font-size: 1.2rem; border: none; }
        p, li { line-height: 1.7; color: #555; }
        pre { background-color: #f0f0f0; padding: 1rem; border-radius: 8px; white-space: pre-wrap; font-family: "SF Mono", monospace; font-size: 0.9rem; }
        .final-accuracy { background-color: #e6f7ff; border-left: 5px solid var(--accent-color-primary); padding: 1rem 1.5rem; font-size: 1.2rem; font-weight: 500; margin: 1.5rem 0; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .image-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1.5rem; }
        .sample-item { text-align: center; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; }
        .sample-item img { width: 100%; max-width: 80px; border-radius: 4px; }
        .prediction-label { font-size: 0.9rem; margin-top: 0.5rem; font-weight: 500; }
        .prediction-correct { color: var(--accent-color-success); }
        .prediction-incorrect { color: var(--accent-color-danger); }
        
        /* Estilos para la nueva sección de predicción */
        .prediction-section { text-align: center; }
        .upload-area { border: 2px dashed var(--accent-color-primary); border-radius: 12px; padding: 2rem; margin: 1rem auto; max-width: 500px; cursor: pointer; background-color: #f0f6ff; transition: background-color 0.2s; }
        .upload-area:hover { background-color: #e6f0ff; }
        #image-preview { max-width: 200px; margin: 1rem auto; border: 1px solid var(--border-color); border-radius: 8px; }
        #prediction-result { font-size: 2.5rem; font-weight: 700; color: var(--accent-color-primary); margin-top: 1rem; min-height: 50px; }
        .action-button { background-color: var(--button-color); color: white; border: none; border-radius: 8px; padding: 12px 24px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; margin-top: 1rem; }
        .action-button:hover { background-color: var(--button-hover-color); }
        .action-button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status-message { font-size: 0.9rem; color: #888; margin-top: 1rem; min-height: 20px; }

        @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header class="card">
            <h1>Análisis y Demo de IA para MNIST</h1>
            <p>Esta es una plataforma completa para analizar el rendimiento de un modelo de IA en el dataset MNIST y probarlo con tus propias imágenes.</p>
        </header>

        <main>
            <!-- SECCIÓN DE PREDICCIÓN INTERACTIVA CON FIREBASE -->
            <section class="card prediction-section">
                <h2>¡Prueba la IA y Guarda el Resultado!</h2>
                <p>Sube una imagen de un número manuscrito. La IA predecirá el dígito y podrás guardar la imagen y el resultado en Firebase.</p>
                <div id="upload-area" class="upload-area">
                    <p>Haz clic aquí o arrastra una imagen</p>
                    <input type="file" id="image-upload" accept="image/*" style="display: none;">
                </div>
                <img id="image-preview" src="" alt="Vista previa de la imagen" style="display:none;"/>
                <h3>Predicción de la IA:</h3>
                <div id="prediction-result">...</div>
                <button id="save-button" class="action-button" disabled>Guardar Resultado en Firebase</button>
                <div id="status-message"></div>
            </section>

            <!-- GRÁFICAS DE PLOTLY -->
            <section class="card">
                <h2>Rendimiento del Modelo: Precisión y Pérdida</h2>
                <p>Las siguientes gráficas muestran la evolución del modelo durante el entrenamiento, evidenciando el sobreajuste (overfitting).</p>
                <div class="grid">
                    <div id="accuracy-chart"></div>
                    <div id="loss-chart"></div>
                </div>
            </section>

            <section class="card">
                <h2>Análisis de Errores: Matriz de Confusión</h2>
                <p>La matriz de confusión revela los aciertos (diagonal) y los errores específicos de clasificación del modelo.</p>
                <div id="confusion-matrix-chart"></div>
                <p class="final-accuracy">{{ final_accuracy }}</p>
            </section>

            <section class="card">
                <h2>Ejemplos de Predicciones</h2>
                <p>Aciertos (verde) y errores (rojo) del modelo sobre el conjunto de prueba.</p>
                <div class="image-gallery">
                    {% for sample in sample_images %}
                    <div class="sample-item">
                        <img src="{{ sample.image }}" alt="Dígito {{ sample.true_label }}">
                        <div class="prediction-label {% if sample.predicted_label == sample.true_label %}prediction-correct{% else %}prediction-incorrect{% endif %}">
                            Real: {{ sample.true_label }} | Pred: {{ sample.predicted_label }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <section class="card">
                <h2>Detalles Técnicos del Modelo</h2>
                <h3>Arquitectura</h3>
                <pre>{{ model_summary }}</pre>
                <h3>Logs de Entrenamiento</h3>
                <pre>{% for log in training_logs %}{{ log }}\n{% endfor %}</pre>
            </section>
        </main>
    </div>

    <script>
        // --- 1. INICIALIZACIÓN DE FIREBASE ---
        // TODO: Pega aquí tu objeto de configuración de Firebase
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const db = firebase.firestore();

        // --- 2. RENDERIZADO DE GRÁFICOS PLOTLY ---
        try {
            const graphsData = JSON.parse({{ graphs_json | tojson_safe }});
            Plotly.newPlot('accuracy-chart', graphsData.accuracy.data, graphsData.accuracy.layout);
            Plotly.newPlot('loss-chart', graphsData.loss.data, graphsData.loss.layout);
            Plotly.newPlot('confusion-matrix-chart', graphsData.confusion_matrix.data, graphsData.confusion_matrix.layout);
        } catch (e) {
            console.error("Error al renderizar los gráficos de Plotly:", e);
        }
        
        // --- 3. LÓGICA DE PREDICCIÓN Y FIREBASE ---
        const uploadArea = document.getElementById('upload-area');
        const imageUpload = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const predictionResult = document.getElementById('prediction-result');
        const saveButton = document.getElementById('save-button');
        const statusMessage = document.getElementById('status-message');

        let currentFile = null;
        let currentPrediction = null;

        uploadArea.addEventListener('click', () => imageUpload.click());
        uploadArea.addEventListener('dragover', (e) => e.preventDefault());
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUpload.files = e.dataTransfer.files;
            handleImageUpload({ target: imageUpload });
        });
        imageUpload.addEventListener('change', handleImageUpload);
        saveButton.addEventListener('click', saveToFirebase);

        async function handleImageUpload(event) {
            currentFile = event.target.files[0];
            if (!currentFile) return;

            saveButton.disabled = true;
            statusMessage.textContent = '';
            
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(currentFile);

            const formData = new FormData();
            formData.append('image', currentFile);
            
            predictionResult.textContent = 'Analizando...';

            try {
                const response = await fetch('/predict', { method: 'POST', body: formData });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Error en la respuesta del servidor');
                }
                const data = await response.json();
                currentPrediction = data.prediction;
                predictionResult.textContent = currentPrediction;
                saveButton.disabled = false; // Habilitar el botón de guardar

            } catch (error) {
                console.error('Error en la predicción:', error);
                predictionResult.textContent = 'Error';
                statusMessage.textContent = `Error al predecir: ${error.message}`;
            }
        }

        async function saveToFirebase() {
            if (!currentFile || currentPrediction === null) {
                alert('Primero debes subir una imagen y obtener una predicción.');
                return;
            }
            if (firebaseConfig.apiKey === "TU_API_KEY") {
                 alert("Error: Debes configurar tus credenciales de Firebase en el archivo index.html");
                 return;
            }

            saveButton.disabled = true;
            statusMessage.textContent = 'Guardando en Firebase...';

            try {
                // 1. Subir imagen a Firebase Storage
                const filePath = `uploads/${Date.now()}_${currentFile.name}`;
                const fileRef = storage.ref(filePath);
                const snapshot = await fileRef.put(currentFile);
                const downloadURL = await snapshot.ref.getDownloadURL();

                // 2. Guardar datos en Firestore
                await db.collection('predictions').add({
                    image_url: downloadURL,
                    predicted_digit: currentPrediction,
                    created_at: firebase.firestore.FieldValue.serverTimestamp()
                });

                statusMessage.textContent = '¡Resultado guardado en Firebase con éxito!';
                console.log('Guardado exitoso!');

            } catch (error) {
                console.error('Error al guardar en Firebase:', error);
                statusMessage.textContent = `Error al guardar: ${error.message}`;
                saveButton.disabled = false;
            }
        }
    </script>
</body>
</html>
